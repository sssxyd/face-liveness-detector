# 照片攻击检测算法文档

## 概述

照片攻击检测器是一种基于关键点运动透视一致性检验的活体检测算法。它通过分析人脸关键点在连续帧中的运动模式，区分真实人脸和照片攻击。

## 核心原理

该算法基于以下关键观察：

1. **真实人脸运动**：由于透视效应，近处点（如鼻尖）的移动幅度大于远处点（如耳朵）
2. **照片攻击**：所有点按照同一仿射变换移动，各点运动向量高度一致

算法通过比较鼻尖、脸颊、耳朵等在多帧中的 2D 位移比例来判断是否为照片攻击。

## 主要功能

### 1. 运动透视一致性检验
- 各关键点运动位移的标准差（高=真实人脸，低=照片）
- 近处点与远处点运动幅度的比值（透视比率）
- 运动向量的方向一致性（高=照片，低=真实人脸）
- 仿射变换模式匹配度（高=照片特征）

### 2. 综合判定
- 是否检测到照片攻击
- 照片检测总置信度 (0-1)

## 算法流程

### 关键点选择
算法选择以下关键点进行分析：
- **近处点**：鼻尖及周围区域（如索引 [1, 4, 6, 195]）
- **中距离点**：脸颊区域（如索引 [127, 356]）
- **远处点**：耳朵区域（如索引 [162, 389]）

### 位移向量计算
对于连续帧对，计算各个关键点的位移向量：
```
displacement.x = currentMesh[idx][0] - previousMesh[idx][0]
displacement.y = currentMesh[idx][1] - previousMesh[idx][1]
displacement.magnitude = sqrt(displacement.x² + displacement.y²)
```

### 四个核心指标计算

#### 1. 运动位移方差
- **真实人脸**：各点运动差异大 → 高方差
- **照片**：各点运动一致 → 低方差

#### 2. 透视比率
- **计算公式**：近处点平均位移 / 远处点平均位移
- **真实人脸**：比率 > 1（近处点移动幅度大）
- **照片**：比率 ≈ 1（所有点移动幅度相同）

#### 3. 运动方向一致性
- 计算所有位移向量与平均方向的夹角余弦值
- **照片**：所有点的运动方向高度一致 → 高分
- **真实人脸**：各点运动方向差异大 → 低分

#### 4. 仿射变换匹配度
- 使用最小二乘法拟合所有点的位移到单一仿射变换
- **照片特征**：拟合度高（高度一致的仿射变换）
- **真实人脸**：拟合度低（各点运动不符合单一变换）

### 综合评分计算
综合四个指标计算最终的照片攻击置信度：

```
variance_indicator = max(0, 1 - motionDisplacementVariance / threshold)
ratio_indicator = 根据透视比率与阈值的关系计算
consistency_indicator = min(1, motionDirectionConsistency / threshold)
affine_indicator = affineTransformPatternMatch

score = min(1, (variance_indicator + ratio_indicator + consistency_indicator + affine_indicator) / 4)
```

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| frameBufferSize | 15 | 缓冲帧数，用于计算时序特征（约0.5秒@30fps） |
| requiredFrameCount | 15 | 可信赖所需的最小帧数 |
| motionVarianceThreshold | 0.005 | 运动方差阈值，真实人脸>0.005，照片<0.005 |
| perspectiveRatioThreshold | 1 | 透视比率阈值，真实人脸>1，照片<1 |
| motionConsistencyThreshold | 0.8 | 运动一致性阈值，真实人脸<0.8，照片>0.8 |

特别注意透视比率阈值的处理逻辑：
- 当阈值等于1时：透视比率<1表明近处点移动<远处点，是明显照片特征
- 当阈值小于1时：使用距离阈值的比例计算
- 当阈值大于1时：透视比率大于阈值更可能是真实人脸

## 算法特点

1. **纯2D几何分析**：不需要深度信息或3D建模
2. **实时性**：基于滑动窗口机制，只保留最近的固定帧数
3. **多维度验证**：从方差、透视、方向一致性、仿射变换四个角度验证
4. **自适应**：能够适应不同的面部运动模式

## 使用场景

此算法适用于以下场景：
- 人脸识别前的活体检测
- 防止照片攻击
- 验证用户是否为真人
- 提高身份认证安全性

## 性能指标

- 时间复杂度：O(n×m)，其中 n 是关键点数量，m 是帧数
- 空间复杂度：O(k)，其中 k 是缓冲区大小
- 推荐帧率：≥15fps，以确保有足够的运动信息进行分析
- 最低帧数要求：至少需要3帧才能开始检测，推荐15帧以上以获得稳定结果

## 经验参数

根据实际测试，在人脸占比50%-90%且正对摄像头的应用场景下：
- 平面照片的透视比率通常集中在 1.04 左右
- 真实人脸因3D结构，该值通常 > 1.08
- 建议将 `perspectiveRatioThreshold` 默认值设为 1.08