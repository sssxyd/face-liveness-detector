> **è¯­è¨€ / Languages:** [ä¸­æ–‡](#) Â· [English](./README.md)

# äººè„¸æ£€æµ‹å¼•æ“

ä¸€ä¸ªåŸºäº **[Human.js](https://github.com/vladmandic/human)** å’Œ **[OpenCV.js](https://github.com/TechStark/opencv-js)** çš„çº¯å‰ç«¯å®æ—¶äººè„¸æ´»ä½“æ£€æµ‹å¼•æ“ã€‚è¿™ä¸ªåŸºäº TypeScript çš„ npm åŒ…æä¾›å®æ—¶äººè„¸æ£€æµ‹ã€åŒé‡æ´»ä½“éªŒè¯ï¼ˆé™é»˜ + åŠ¨ä½œæ£€æµ‹ï¼‰ã€è‡ªåŠ¨æœ€ä½³å¸§é€‰æ‹©å’Œé˜²æ¬ºéª—åŠŸèƒ½ - æ‰€æœ‰å¤„ç†éƒ½ 100% åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œé›¶åç«¯ä¾èµ–ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ’¯ **çº¯å‰ç«¯å®ç°** - é›¶åç«¯ä¾èµ–ï¼Œæ‰€æœ‰å¤„ç†åœ¨æµè§ˆå™¨ä¸­æœ¬åœ°è¿è¡Œ
- ğŸ”¬ **æ··åˆ TensorFlow + OpenCV æ–¹æ¡ˆ** - ç»“åˆ TensorFlow.js è¿›è¡Œ AI æ£€æµ‹å’Œ OpenCV.js è¿›è¡Œå›¾åƒå¤„ç†
- ğŸ§  **åŒæ£€æµ‹æ¨¡å¼** - æ”¯æŒé™é»˜æ´»ä½“æ£€æµ‹å’ŒåŠ¨ä½œæ£€æµ‹ï¼ˆçœ¨çœ¼ã€å¼ å˜´ã€ç‚¹å¤´ï¼‰ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³å¸§
- âš¡ **çº¯ JavaScript å’Œäº‹ä»¶é©±åŠ¨** - 100% TypeScriptï¼Œå“åº”å¼äº‹ä»¶æ¶æ„ï¼Œä¸ä»»ä½•å‰ç«¯æ¡†æ¶ï¼ˆVueã€Reactã€Angularã€Svelte æˆ–åŸç”Ÿ JSï¼‰æ— ç¼é›†æˆ
- ğŸ¯ **å…¨é¢çš„äººè„¸åˆ†æ** - å®æ—¶é˜²æ¬ºéª—ã€è´¨é‡è¯„ä¼°ã€æ­£é¢åº¦æ£€æµ‹å’Œæ¨¡ç³Šæ£€æµ‹
- ğŸ›¡ï¸ **é«˜çº§é˜²æ¬ºéª—** - å®æ—¶æ´»ä½“åˆ†æ•°å’Œæ¬ºéª—æ£€æµ‹

## ğŸš€ åœ¨çº¿æ¼”ç¤º

**[ğŸ‘‰ åœ¨çº¿æ¼”ç¤º: https://face.lowtechsoft.com/](https://face.lowtechsoft.com/)**

ç”¨æ‰‹æœºæ‰«æäºŒç»´ç ç«‹å³æµ‹è¯•æ£€æµ‹å¼•æ“ï¼š

[![äººè„¸æ´»ä½“æ£€æµ‹æ¼”ç¤ºäºŒç»´ç ](https://raw.githubusercontent.com/sssxyd/face-liveness-detector/main/demos/vue-demo/vue-demo.png)](https://face.lowtechsoft.com/)

## å®‰è£…

```bash
npm install @sssxyd/face-liveness-detector @vladmandic/human @techstark/opencv-js
```

æˆ–ä½¿ç”¨ yarnï¼š
```bash
yarn add @sssxyd/face-liveness-detector @vladmandic/human @techstark/opencv-js
```

æˆ–ä½¿ç”¨ pnpmï¼š
```bash
pnpm add @sssxyd/face-liveness-detector @vladmandic/human @techstark/opencv-js
```

> **æ³¨æ„**ï¼š`@vladmandic/human` å’Œ `@techstark/opencv-js` æ˜¯å¯¹ç­‰ä¾èµ–ï¼Œå¿…é¡»å•ç‹¬å®‰è£…ä»¥é¿å…æ†ç»‘å¤§å‹åº“ã€‚å¦‚æœæ‚¨åœ¨é¡¹ç›®çš„å…¶ä»–åœ°æ–¹å·²ç»ä½¿ç”¨è¿™äº›åº“ï¼Œè¿™æ ·åšå¯ä»¥å‡å°æœ€ç»ˆçš„æ‰“åŒ…å¤§å°ã€‚

## å¿«é€Ÿå¼€å§‹ - ä½¿ç”¨æœ¬åœ°èµ„æº

> âš ï¸ **é‡è¦æç¤º**ï¼š`@techstark/opencv-js` åŒ…å«ä¸€ä¸ª ESM ä¸å…¼å®¹çš„ UMD æ ¼å¼ OpenCV.js åº“ï¼Œ**ä¼šå¯¼è‡´åŠ è½½å¤±è´¥**ã€‚æ‚¨å¿…é¡»åº”ç”¨è¡¥ä¸è„šæœ¬ã€‚
> - **é—®é¢˜é“¾æ¥**ï¼šhttps://github.com/TechStark/opencv-js/issues/44
> - **è¡¥ä¸è„šæœ¬**ï¼š[patch-opencv.js](https://github.com/sssxyd/face-liveness-detector/tree/main/demos/vue-demo/scripts/patch-opencv.js)
> - **è®¾ç½®æ–¹æ³•**ï¼šæ·»åŠ åˆ° `package.json` çš„è„šæœ¬ä¸­ä½œä¸º `postinstall` é’©å­ï¼Œåœ¨ä¾èµ–å®‰è£…åè‡ªåŠ¨åº”ç”¨

> âš ï¸ **é‡è¦æç¤º**ï¼š`@vladmandic/human` éœ€è¦ä¸‹è½½å¤§å‹æ¨¡å‹æ–‡ä»¶å’Œ TensorFlow WASM åç«¯æ–‡ä»¶ã€‚**æ²¡æœ‰è¿™äº›èµ„æºç»„ä»¶å°†æ— æ³•åŠ è½½**ã€‚ä¸‹è½½å®ƒä»¬åˆ°æ‚¨çš„é¡¹ç›®ç›®å½•å¹¶é…ç½®è·¯å¾„ã€‚
> - **æ¨¡å‹ä¸‹è½½è„šæœ¬**ï¼š[copy-models.js](https://github.com/sssxyd/face-liveness-detector/tree/main/demos/vue-demo/scripts/copy-models.js)
> - **WASM ä¸‹è½½è„šæœ¬**ï¼š[download-wasm.js](https://github.com/sssxyd/face-liveness-detector/tree/main/demos/vue-demo/scripts/download-wasm.js)
> - **è®¾ç½®æ–¹æ³•**ï¼šè¿è¡Œä¸¤ä¸ªè„šæœ¬ä½œä¸º `postinstall` é’©å­ï¼Œç„¶ååœ¨å¼•æ“é…ç½®ä¸­é…ç½®è·¯å¾„

```typescript
import FaceDetectionEngine, { LivenessAction } from '@sssxyd/face-liveness-detector'

// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åˆå§‹åŒ–å¼•æ“
const engine = new FaceDetectionEngine({
  // é…ç½®èµ„æºè·¯å¾„
  human_model_path: '/models',
  tensorflow_wasm_path: '/wasm',
  
  // æ£€æµ‹è®¾ç½®
  video_width: 640,
  video_height: 640,
  
  // è´¨é‡è®¾ç½®
  min_image_quality: 0.5,
  min_face_frontal: 0.9,
  
  // æ´»ä½“è®¾ç½® - é€‰æ‹©æ‚¨åå¥½çš„åŠ¨ä½œ
  liveness_action_count: 1,  // 0 è¡¨ç¤ºä»…é™é»˜æ£€æµ‹ï¼Œ1-3 è¡¨ç¤ºåŠ¨ä½œæ£€æµ‹
  liveness_action_list: [LivenessAction.BLINK, LivenessAction.MOUTH_OPEN, LivenessAction.NOD]
})

// ç›‘å¬äº‹ä»¶
engine.on('detector-loaded', (data) => {
  console.log('âœ… å¼•æ“å·²å°±ç»ª')
  console.log(`OpenCV: ${data.opencv_version}`)
  console.log(`Human.js: ${data.human_version}`)
})

engine.on('detector-info', (data) => {
  // å®æ—¶æ£€æµ‹ä¿¡æ¯
  console.log({
    quality: (data.quality * 100).toFixed(1) + '%',
    frontal: (data.frontal * 100).toFixed(1) + '%',
    liveness: (data.live * 100).toFixed(1) + '%',
    realness: (data.real * 100).toFixed(1) + '%'
  })
})

engine.on('detector-action', (data) => {
  // åŠ¨ä½œæ´»ä½“æç¤º
  if (data.status === 'started') {
    console.log(`è¯·æ‰§è¡ŒåŠ¨ä½œ: ${data.action}`)
  } else if (data.status === 'completed') {
    console.log(`âœ… åŠ¨ä½œè¯†åˆ«æˆåŠŸ: ${data.action}`)
  }
})

engine.on('detector-finish', (data) => {
  if (data.success) {
    console.log('âœ… æ´»ä½“éªŒè¯é€šè¿‡ï¼')
    console.log({
      silentDetections: data.silentPassedCount,
      actionsCompleted: data.actionPassedCount,
      imageQuality: (data.bestQualityScore * 100).toFixed(1) + '%',
      totalTime: (data.totalTime / 1000).toFixed(2) + 's',
      bestFrame: data.bestFrameImage,  // Base64 ç¼–ç 
      bestFace: data.bestFaceImage     // Base64 ç¼–ç 
    })
  } else {
    console.log('âŒ æ´»ä½“éªŒè¯å¤±è´¥')
  }
})

engine.on('detector-error', (error) => {
  console.error(`é”™è¯¯ [${error.code}]: ${error.message}`)
})

engine.on('detector-debug', (debug) => {
  console.log(`[${debug.stage}] ${debug.message}`)
})

// åˆå§‹åŒ–å¹¶å¼€å§‹æ£€æµ‹
async function runDetection() {
  try {
    // åˆå§‹åŒ–åº“ï¼ˆæ¨¡å‹ã€TensorFlow WASM ç­‰ï¼‰
    await engine.initialize()
    
    // è·å–è§†é¢‘å…ƒç´ 
    const videoElement = document.getElementById('video') as HTMLVideoElement
    
    // åœ¨è§†é¢‘æµä¸Šå¼€å§‹æ£€æµ‹
    await engine.startDetection(videoElement)
    
    // æ£€æµ‹ä¸€ç›´è¿è¡Œåˆ°å®Œæˆæˆ–å‡ºé”™
    // å¦‚éœ€åœæ­¢å¯æ‰‹åŠ¨è°ƒç”¨:
    // engine.stopDetection(true)  // true è¡¨ç¤ºæ˜¾ç¤ºæœ€ä½³å›¾åƒ
  } catch (error) {
    console.error('æ£€æµ‹å¯åŠ¨å¤±è´¥:', error)
  }
}

// å°±ç»ªæ—¶è°ƒç”¨
runDetection()
```

## é…ç½®

### FaceDetectionEngineConfig

#### èµ„æºè·¯å¾„

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `human_model_path` | `string` | Human.js æ¨¡å‹æ–‡ä»¶è·¯å¾„ | `undefined` |
| `tensorflow_wasm_path` | `string` | TensorFlow WASM æ–‡ä»¶è·¯å¾„ | `undefined` |
| `tensorflow_backend` | `'auto' \| 'webgl' \| 'wasm'` | TensorFlow åç«¯é€‰æ‹© | `'auto'` |

#### è§†é¢‘æ£€æµ‹è®¾ç½®

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `video_width` | `number` | è§†é¢‘æµå®½åº¦ï¼ˆåƒç´ ï¼‰ | `640` |
| `video_height` | `number` | è§†é¢‘æµé«˜åº¦ï¼ˆåƒç´ ï¼‰ | `640` |
| `video_mirror` | `boolean` | æ°´å¹³é•œåƒç¿»è½¬è§†é¢‘ | `true` |
| `video_load_timeout` | `number` | è§†é¢‘æµåŠ è½½è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `5000` |
| `detection_frame_delay` | `number` | æ£€æµ‹å¸§é—´å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | `100` |
| `error_retry_delay` | `number` | é”™è¯¯é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | `200` |

#### æ£€æµ‹è´¨é‡è®¾ç½®

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `silent_detect_count` | `number` | é™é»˜æ£€æµ‹æ”¶é›†æ•°é‡ | `3` |
| `min_face_ratio` | `number` | æœ€å°äººè„¸å°ºå¯¸æ¯”ä¾‹ (0-1) | `0.5` |
| `max_face_ratio` | `number` | æœ€å¤§äººè„¸å°ºå¯¸æ¯”ä¾‹ (0-1) | `0.9` |
| `min_face_frontal` | `number` | æœ€å°äººè„¸æ­£é¢åº¦ (0-1) | `0.9` |
| `min_image_quality` | `number` | æœ€å°å›¾åƒè´¨é‡åˆ†æ•° (0-1) | `0.5` |
| `min_live_score` | `number` | æœ€å°æ´»ä½“åˆ†æ•° (0-1) | `0.5` |
| `min_real_score` | `number` | æœ€å°é˜²æ¬ºéª—åˆ†æ•° (0-1) | `0.85` |
| `suspected_frauds_count` | `number` | æ£€æµ‹åˆ°æ¬ºéª—å‰çš„æ£€æµ‹æ•°é‡ | `3` |

#### äººè„¸æ­£é¢åº¦ç‰¹å¾ (`face_frontal_features`)

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `yaw_threshold` | `number` | åèˆªè§’é˜ˆå€¼ï¼ˆåº¦æ•°ï¼‰ | `3` |
| `pitch_threshold` | `number` | ä¿¯ä»°è§’é˜ˆå€¼ï¼ˆåº¦æ•°ï¼‰ | `4` |
| `roll_threshold` | `number` | ç¿»æ»šè§’é˜ˆå€¼ï¼ˆåº¦æ•°ï¼‰ | `2` |

#### å›¾åƒè´¨é‡ç‰¹å¾ (`image_quality_features`)

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `require_full_face_in_bounds` | `boolean` | è¦æ±‚äººè„¸å®Œå…¨åœ¨è¾¹ç•Œå†… | `false` |
| `use_opencv_enhancement` | `boolean` | ä½¿ç”¨ OpenCV å¢å¼ºè¿›è¡Œè´¨é‡æ£€æµ‹ | `true` |
| `min_laplacian_variance` | `number` | æœ€å°æ‹‰æ™®æ‹‰æ–¯æ–¹å·®ï¼ˆæ¨¡ç³Šæ£€æµ‹ï¼‰ | `50` |
| `min_gradient_sharpness` | `number` | æœ€å°æ¢¯åº¦æ¸…æ™°åº¦ï¼ˆæ¨¡ç³Šæ£€æµ‹ï¼‰ | `0.15` |
| `min_blur_score` | `number` | æœ€å°æ¨¡ç³Šåˆ†æ•° | `0.6` |

#### æ´»ä½“æ£€æµ‹è®¾ç½®

| å±æ€§ | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|------|------|--------|
| `liveness_action_list` | `LivenessAction[]` | æ´»ä½“æ£€æµ‹åŠ¨ä½œåˆ—è¡¨ | `[BLINK, MOUTH_OPEN, NOD]` |
| `liveness_action_count` | `number` | éœ€è¦æ‰§è¡Œçš„æ´»ä½“åŠ¨ä½œæ•°é‡ | `1` |
| `liveness_action_randomize` | `boolean` | æ˜¯å¦éšæœºåŒ–æ´»ä½“åŠ¨ä½œé¡ºåº | `true` |
| `liveness_verify_timeout` | `number` | æ´»ä½“éªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `60000` |
| `min_mouth_open_percent` | `number` | æœ€å°å¼ å˜´ç™¾åˆ†æ¯” (0-1) | `0.2` |

## API å‚è€ƒ

### æ–¹æ³•

#### `initialize(): Promise<void>`
åŠ è½½å¹¶åˆå§‹åŒ–æ£€æµ‹åº“ã€‚ä½¿ç”¨æ£€æµ‹åŠŸèƒ½å‰å¿…é¡»è°ƒç”¨ã€‚

```typescript
await engine.initialize()
```

#### `startDetection(videoElement): Promise<void>`
åœ¨è§†é¢‘å…ƒç´ ä¸Šå¼€å§‹äººè„¸æ£€æµ‹ã€‚

```typescript
const videoElement = document.getElementById('video') as HTMLVideoElement
await engine.startDetection(videoElement)
```

#### `stopDetection(success?: boolean): void`
åœæ­¢æ£€æµ‹è¿‡ç¨‹ã€‚

```typescript
engine.stopDetection(true)  // true è¡¨ç¤ºæ˜¾ç¤ºæœ€ä½³å›¾åƒ
```

#### `updateConfig(config): void`
åœ¨è¿è¡Œæ—¶æ›´æ–°é…ç½®ã€‚

```typescript
engine.updateConfig({
  min_face_ratio: 0.6,
  liveness_action_count: 2
})
```

#### `getConfig(): FaceDetectionEngineConfig`
è·å–å½“å‰é…ç½®ã€‚

```typescript
const config = engine.getConfig()
```

#### `getStatus(): Object`
è·å–å¼•æ“çŠ¶æ€ã€‚

```typescript
const { isReady, isDetecting, isInitializing } = engine.getStatus()
```

### äº‹ä»¶

å¼•æ“ä½¿ç”¨ TypeScript äº‹ä»¶å‘å°„å™¨æ¨¡å¼ã€‚æ‰€æœ‰äº‹ä»¶éƒ½æ˜¯ç±»å‹å®‰å…¨çš„ï¼š

#### `detector-loaded`
å¼•æ“å®Œæˆåˆå§‹åŒ–æ—¶è§¦å‘ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorLoadedEventData {
  success: boolean        // åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ
  error?: string          // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
  opencv_version?: string // OpenCV.js ç‰ˆæœ¬
  human_version?: string  // Human.js ç‰ˆæœ¬
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-loaded', (data) => {
  if (data.success) {
    console.log('âœ… å¼•æ“å°±ç»ª')
    console.log(`OpenCV: ${data.opencv_version}`)
    console.log(`Human.js: ${data.human_version}`)
  } else {
    console.error('å¼•æ“åˆå§‹åŒ–å¤±è´¥:', data.error)
  }
})
```

#### `detector-info`
æ¯å¸§çš„å®æ—¶æ£€æµ‹ä¿¡æ¯ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorInfoEventData {
  passed: boolean     // é™é»˜æ´»ä½“æ£€æŸ¥æ˜¯å¦é€šè¿‡
  code: DetectionCode // æ£€æµ‹çŠ¶æ€ç 
  size: number        // äººè„¸å°ºå¯¸æ¯”ä¾‹ (0-1)
  frontal: number     // äººè„¸æ­£é¢åº¦åˆ†æ•° (0-1)
  quality: number     // å›¾åƒè´¨é‡åˆ†æ•° (0-1)
  real: number        // é˜²æ¬ºéª—åˆ†æ•° (0-1)
  live: number        // æ´»ä½“åˆ†æ•° (0-1)
}
```

**æ£€æµ‹ä»£ç ï¼š**
```typescript
enum DetectionCode {
  VIDEO_NO_FACE = 'VIDEO_NO_FACE',        // æœªæ£€æµ‹åˆ°äººè„¸
  MULTIPLE_FACE = 'MULTIPLE_FACE',        // æ£€æµ‹åˆ°å¤šå¼ äººè„¸
  FACE_TOO_SMALL = 'FACE_TOO_SMALL',      // äººè„¸å¤ªå°
  FACE_TOO_LARGE = 'FACE_TOO_LARGE',      // äººè„¸å¤ªå¤§
  FACE_NOT_FRONTAL = 'FACE_NOT_FRONTAL',  // äººè„¸ä¸å¤Ÿæ­£é¢
  FACE_NOT_REAL = 'FACE_NOT_REAL',        // ç–‘ä¼¼æ¬ºéª—
  FACE_NOT_LIVE = 'FACE_NOT_LIVE',        // æ´»ä½“åˆ†æ•°è¿‡ä½
  FACE_LOW_QUALITY = 'FACE_LOW_QUALITY',  // å›¾åƒè´¨é‡è¿‡ä½
  FACE_CHECK_PASS = 'FACE_CHECK_PASS'     // æ‰€æœ‰æ£€æŸ¥é€šè¿‡
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-info', (data) => {
  console.log({
    passed: data.passed,
    status: data.code,
    quality: (data.quality * 100).toFixed(1) + '%',
    frontal: (data.frontal * 100).toFixed(1) + '%',
    liveness: (data.live * 100).toFixed(1) + '%',
    realness: (data.real * 100).toFixed(1) + '%'
  })
})
```

#### `detector-action`
åŠ¨ä½œæ´»ä½“æç¤ºå’ŒçŠ¶æ€æ›´æ–°ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorActionEventData {
  action: LivenessAction    // è¦æ‰§è¡Œçš„åŠ¨ä½œ
  status: LivenessActionStatus // åŠ¨ä½œçŠ¶æ€
}
```

**åŠ¨ä½œç±»å‹ï¼š**
```typescript
enum LivenessAction {
  BLINK = 'blink',
  MOUTH_OPEN = 'mouth_open',
  NOD = 'nod'
}
```

**åŠ¨ä½œçŠ¶æ€ï¼š**
```typescript
enum LivenessActionStatus {
  STARTED = 'started',      // åŠ¨ä½œæç¤ºå·²å¼€å§‹
  COMPLETED = 'completed',  // åŠ¨ä½œè¯†åˆ«æˆåŠŸ
  TIMEOUT = 'timeout'       // åŠ¨ä½œè¯†åˆ«è¶…æ—¶
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-action', (data) => {
  switch (data.status) {
    case 'started':
      console.log(`ğŸ‘¤ è¯·æ‰§è¡Œ: ${data.action}`)
      // æ›´æ–° UI æ˜¾ç¤ºåŠ¨ä½œæç¤º
      break
    case 'completed':
      console.log(`âœ… åŠ¨ä½œè¯†åˆ«: ${data.action}`)
      // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
      break
    case 'timeout':
      console.log(`â±ï¸ åŠ¨ä½œè¶…æ—¶: ${data.action}`)
      break
  }
})
```

#### `detector-finish`
æ´»ä½“æ£€æµ‹å®Œæˆæ—¶è§¦å‘ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorFinishEventData {
  success: boolean         // æ´»ä½“éªŒè¯æ˜¯å¦é€šè¿‡
  silentPassedCount: number    // é™é»˜æ£€æµ‹é€šè¿‡æ•°é‡
  actionPassedCount: number    // åŠ¨ä½œå®Œæˆæ•°é‡
  totalTime: number        // æ€»æ£€æµ‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  bestQualityScore: number // æœ€ä½³å›¾åƒè´¨é‡åˆ†æ•° (0-1)
  bestFrameImage: string | null  // Base64 ç¼–ç çš„æœ€ä½³å¸§å›¾åƒ
  bestFaceImage: string | null   // Base64 ç¼–ç çš„æœ€ä½³äººè„¸å›¾åƒ
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-finish', (data) => {
  if (data.success) {
    console.log('âœ… æ´»ä½“éªŒè¯é€šè¿‡ï¼')
    console.log({
      silentDetections: data.silentPassedCount,
      actionsCompleted: data.actionPassedCount,
      quality: (data.bestQualityScore * 100).toFixed(1) + '%',
      time: (data.totalTime / 1000).toFixed(2) + 's'
    })
    
    // å‘é€ç»“æœåˆ°æœåŠ¡å™¨
    if (data.bestFrameImage) {
      uploadVerificationResult({
        image: data.bestFrameImage,
        quality: data.bestQualityScore,
        timestamp: new Date()
      })
    }
  } else {
    console.log('âŒ æ´»ä½“éªŒè¯å¤±è´¥')
    // æç¤ºç”¨æˆ·é‡è¯•
  }
})
```

#### `detector-error`
æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorErrorEventData {
  code: ErrorCode // é”™è¯¯ä»£ç 
  message: string // é”™è¯¯ä¿¡æ¯
}
```

**é”™è¯¯ä»£ç ï¼š**
```typescript
enum ErrorCode {
  DETECTOR_NOT_INITIALIZED = 'DETECTOR_NOT_INITIALIZED',
  CAMERA_ACCESS_DENIED = 'CAMERA_ACCESS_DENIED',
  STREAM_ACQUISITION_FAILED = 'STREAM_ACQUISITION_FAILED',
  SUSPECTED_FRAUDS_DETECTED = 'SUSPECTED_FRAUDS_DETECTED'
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-error', (error) => {
  console.error(`âŒ é”™è¯¯ [${error.code}]: ${error.message}`)
  
  switch (error.code) {
    case 'CAMERA_ACCESS_DENIED':
      showErrorMessage('è¯·æˆäºˆæ‘„åƒå¤´æƒé™')
      break
    case 'STREAM_ACQUISITION_FAILED':
      showErrorMessage('æ‘„åƒå¤´è®¿é—®å¤±è´¥')
      break
    case 'SUSPECTED_FRAUDS_DETECTED':
      showErrorMessage('æ£€æµ‹åˆ°æ¬ºéª— - è¯·é‡è¯•')
      break
    default:
      showErrorMessage('æ£€æµ‹å¤±è´¥: ' + error.message)
  }
})
```

#### `detector-debug`
å¼€å‘å’Œæ•…éšœæ’é™¤çš„è°ƒè¯•ä¿¡æ¯ã€‚

**æ•°æ®ï¼š**
```typescript
interface DetectorDebugEventData {
  level: 'info' | 'warn' | 'error'  // è°ƒè¯•çº§åˆ«
  stage: string                      // å½“å‰å¤„ç†é˜¶æ®µ
  message: string                    // è°ƒè¯•ä¿¡æ¯
  details?: Record<string, any>      // é¢å¤–è¯¦æƒ…
  timestamp: number                  // Unix æ—¶é—´æˆ³
}
```

**ç¤ºä¾‹ï¼š**
```typescript
engine.on('detector-debug', (debug) => {
  const time = new Date(debug.timestamp).toLocaleTimeString()
  console.log(`[${time}] [${debug.stage}] ${debug.message}`)
  
  if (debug.details) {
    console.log('è¯¦æƒ…:', debug.details)
  }
  
  // è®°å½•é”™è¯¯ä»¥ä¾¿æ•…éšœæ’é™¤
  if (debug.level === 'error') {
    logErrorToServer({
      stage: debug.stage,
      message: debug.message,
      details: debug.details
    })
  }
})
```

## æšä¸¾

### LivenessAction
```typescript
enum LivenessAction {
  BLINK = 'blink',
  MOUTH_OPEN = 'mouth_open',
  NOD = 'nod'
}
```

### LivenessActionStatus
```typescript
enum LivenessActionStatus {
  STARTED = 'started',      // åŠ¨ä½œæç¤ºå·²å¼€å§‹
  COMPLETED = 'completed',  // åŠ¨ä½œæˆåŠŸè¯†åˆ«
  TIMEOUT = 'timeout'       // åŠ¨ä½œè¯†åˆ«è¶…æ—¶
}
```

### DetectionCode
```typescript
enum DetectionCode {
  VIDEO_NO_FACE = 'VIDEO_NO_FACE',            // è§†é¢‘ä¸­æœªæ£€æµ‹åˆ°äººè„¸
  MULTIPLE_FACE = 'MULTIPLE_FACE',            // æ£€æµ‹åˆ°å¤šå¼ äººè„¸
  FACE_TOO_SMALL = 'FACE_TOO_SMALL',          // äººè„¸å°ºå¯¸å°äºæœ€å°é˜ˆå€¼
  FACE_TOO_LARGE = 'FACE_TOO_LARGE',          // äººè„¸å°ºå¯¸å¤§äºæœ€å¤§é˜ˆå€¼
  FACE_NOT_FRONTAL = 'FACE_NOT_FRONTAL',      // äººè„¸è§’åº¦ä¸å¤Ÿæ­£é¢
  FACE_NOT_REAL = 'FACE_NOT_REAL',            // æ£€æµ‹åˆ°ç–‘ä¼¼æ¬ºéª—
  FACE_NOT_LIVE = 'FACE_NOT_LIVE',            // æ´»ä½“åˆ†æ•°ä½äºé˜ˆå€¼
  FACE_LOW_QUALITY = 'FACE_LOW_QUALITY',      // å›¾åƒè´¨é‡ä½äºæœ€å°å€¼
  FACE_CHECK_PASS = 'FACE_CHECK_PASS'         // æ‰€æœ‰æ£€æµ‹æ£€æŸ¥é€šè¿‡
}
```

### ErrorCode
```typescript
enum ErrorCode {
  DETECTOR_NOT_INITIALIZED = 'DETECTOR_NOT_INITIALIZED',  // å¼•æ“æœªåˆå§‹åŒ–
  CAMERA_ACCESS_DENIED = 'CAMERA_ACCESS_DENIED',          // æ‘„åƒå¤´æƒé™è¢«æ‹’
  STREAM_ACQUISITION_FAILED = 'STREAM_ACQUISITION_FAILED', // è·å–è§†é¢‘æµå¤±è´¥
  SUSPECTED_FRAUDS_DETECTED = 'SUSPECTED_FRAUDS_DETECTED'  // æ£€æµ‹åˆ°æ¬ºéª—/æ¬ºè¯ˆ
}
```

## é«˜çº§ç”¨æ³•

æœ‰å…³å…¨é¢çš„ç¤ºä¾‹å’Œé«˜çº§ç”¨æ³•æ¨¡å¼ï¼Œè¯·å‚è€ƒå®˜æ–¹æ¼”ç¤ºé¡¹ç›®ï¼š

**ğŸ‘‰ [Vue æ¼”ç¤ºé¡¹ç›®](https://github.com/sssxyd/face-liveness-detector/tree/main/demos/vue-demo/)**

æ¼”ç¤ºåŒ…æ‹¬ï¼š
- å®Œæ•´çš„ Vue 3 ä¸ TypeScript é›†æˆ
- å®æ—¶æ£€æµ‹å¯è§†åŒ–
- é…ç½®é¢æ¿ç”¨äºå°è¯•ä¸åŒè®¾ç½®
- æ‰€æœ‰å¼•æ“äº‹ä»¶çš„äº‹ä»¶å¤„ç†ç¤ºä¾‹
- æ˜¾ç¤ºè¯¦ç»†æ£€æµ‹ä¿¡æ¯çš„è°ƒè¯•é¢æ¿
- ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯å“åº”å¼ UI è®¾è®¡
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆæ¨¡å¼
- ç»“æœå¯¼å‡ºå’Œå›¾åƒæ•è·ç¤ºä¾‹

æœ¬åœ°è¿è¡Œæ¼”ç¤ºï¼š

```bash
cd demos/vue-demo
npm install
npm run dev
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ˜¾ç¤ºçš„æœ¬åœ° URL æŸ¥çœ‹æ£€æµ‹å¼•æ“è¿è¡Œæƒ…å†µã€‚

## ä¸‹è½½å¹¶æ‰˜ç®¡æ¨¡å‹æ–‡ä»¶

ä¸ºäº†é¿å… CDN ä¾èµ–å¹¶æé«˜æ€§èƒ½ï¼Œæ‚¨å¯ä»¥åœ¨æœ¬åœ°ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼š

### å¯ç”¨çš„ä¸‹è½½è„šæœ¬

æ ¹ç›®å½•æä¾›äº†ä¸¤ä¸ªè„šæœ¬ï¼š

#### 1. å¤åˆ¶ Human.js æ¨¡å‹

```bash
node copy-human-models.js
```

**åŠŸèƒ½ï¼š**
- ä» `node_modules/@vladmandic/human/models` å¤åˆ¶äººè„¸æ£€æµ‹æ¨¡å‹
- ä¿å­˜åˆ° `public/models/` ç›®å½•
- ä¸‹è½½ `.json` å’Œ `.bin` æ¨¡å‹æ–‡ä»¶
- æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œè¿›åº¦

#### 2. ä¸‹è½½ TensorFlow.js WASM æ–‡ä»¶

```bash
node download-tensorflow-wasm.js
```

**åŠŸèƒ½ï¼š**
- ä¸‹è½½ TensorFlow.js WASM åç«¯æ–‡ä»¶
- ä¿å­˜åˆ° `public/wasm/` ç›®å½•
- ä¸‹è½½ 4 ä¸ªå…³é”®æ–‡ä»¶ï¼š
  - `tf-backend-wasm.min.js`
  - `tfjs-backend-wasm.wasm`
  - `tfjs-backend-wasm-simd.wasm`
  - `tfjs-backend-wasm-threaded-simd.wasm`
- **æ”¯æŒå¤šä¸ª CDN æº**ï¼Œå¹¶è‡ªåŠ¨å›é€€ï¼š
  1. unpkg.comï¼ˆä¸»è¦ï¼‰
  2. cdn.jsdelivr.netï¼ˆå¤‡ç”¨ï¼‰
  3. esm.shï¼ˆå¤‡é€‰ï¼‰
  4. cdn.esm.shï¼ˆæœ€åé€‰æ‹©ï¼‰

### é…ç½®ä½¿ç”¨æœ¬åœ°æ–‡ä»¶

ä¸‹è½½å®Œæˆåï¼Œé…ç½®å¼•æ“ä½¿ç”¨è¿™äº›æœ¬åœ°æ–‡ä»¶ï¼š

```typescript
const engine = new FaceDetectionEngine({
  // ä½¿ç”¨æœ¬åœ°æ–‡ä»¶è€Œä¸æ˜¯ CDN
  human_model_path: '/models',
  tensorflow_wasm_path: '/wasm',
  
  // å…¶ä»–é…ç½®...
})
```

## æµè§ˆå™¨éœ€æ±‚

- æ”¯æŒ WebRTC çš„ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeã€Safari 11+ï¼‰
- getUserMedia éœ€è¦ HTTPSï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ localhostï¼‰
- WebGL æˆ– WASM åç«¯æ”¯æŒ

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è°ƒæ•´æ£€æµ‹å¸§å»¶è¿Ÿ** - å»¶è¿Ÿè¶Šå¤§ = CPU ä½¿ç”¨è¶Šä½ï¼Œä½†æ£€æµ‹è¶Šæ…¢
   ```typescript
   engine.updateConfig({ detection_frame_delay: 200 })
   ```

2. **å‡å°ç”»å¸ƒå°ºå¯¸** - æ›´å°çš„ç”»å¸ƒå¤„ç†æ›´å¿«
   ```typescript
   engine.updateConfig({ 
     video_width: 480,
     video_height: 480
   })
   ```

3. **ä¼˜åŒ–å…‰çº¿æ¡ä»¶** - æ›´å¥½çš„å…‰çº¿ = æ›´å¥½çš„æ£€æµ‹
   - é¿å…èƒŒå…‰
   - ç¡®ä¿äººè„¸å…‰çº¿å……è¶³

4. **ç›‘æ§è°ƒè¯•è¾“å‡º** - ä½¿ç”¨è°ƒè¯•äº‹ä»¶è¯†åˆ«ç“¶é¢ˆ
   ```typescript
   engine.on('detector-debug', (debug) => {
     if (debug.stage === 'detection') {
       console.time(debug.message)
     }
   })
   ```

## æ•…éšœæ’é™¤

### "æ‘„åƒå¤´è®¿é—®è¢«æ‹’"
- ç¡®ä¿ä½¿ç”¨ HTTPSï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ localhostï¼‰
- æ£€æŸ¥æµè§ˆå™¨æƒé™
- ç”¨æˆ·å¿…é¡»æˆäºˆæ‘„åƒå¤´è®¿é—®æƒé™

### "è§†é¢‘åŠ è½½è¶…æ—¶"
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯æ¨¡å‹æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
- å¢åŠ  `video_load_timeout`

### æ£€æµ‹ç²¾åº¦ä¸ä½³
- ç¡®ä¿å…‰çº¿å……è¶³
- ä¿æŒäººè„¸åœ¨ç”»é¢ä¸­å±…ä¸­
- äººè„¸åº”å ç”»é¢çš„ 50-90%
- äººè„¸åº”æ­£é¢ï¼ˆä¸å€¾æ–œï¼‰

### CPU ä½¿ç”¨ç‡è¿‡é«˜
- å¢åŠ  `detection_frame_delay`
- å‡å° `video_width` å’Œ `video_height`
- ç¦ç”¨ `show_action_prompt`ï¼ˆå¦‚ä¸éœ€è¦ï¼‰

## è®¸å¯è¯

MIT

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—®ï¼šhttps://github.com/sssxyd/face-liveness-detector/issues
